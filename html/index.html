<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>토벌전 참여 현황</title>
    <link rel="stylesheet" href="../static/css/style.css">
</head>
<body>
<div class="container">
    <div class="header">
        <h1>토벌전 참여 현황</h1>
    </div>

    <table class="data-table">
        <thead>
        <tr>
            <th style="width: 10%;">유저정보</th>
            <th style="width: 9%;">드래곤</th>
            <th style="width: 9%;">대천사</th>
            <th style="width: 9%;">기계신</th>
            <th style="width: 9%;">총합</th>
            <th style="width: 9%;">드래곤<br>(전시즌대비)</th>
            <th style="width: 9%;">대천사<br>(전시즌대비)</th>
            <th style="width: 9%;">기계신<br>(전시즌대비)</th>
            <th style="width: 9%;">티켓당드래곤<br>(전시즌대비)</th>
            <th style="width: 9%;">티켓당대천사<br>(전시즌대비)</th>
            <th style="width: 9%;">티켓당기계신<br>(전시즌대비)</th>
        </tr>
        </thead>
        <tbody id="player-tbody">
        </tbody>
    </table>

    <div class="footer">
        <div class="format-options">
            <div class="format-option">
                <input type="radio" id="korean-format" name="format" value="korean" checked>
                <label for="korean-format">만단위 구분</label>
            </div>
            <div class="format-option">
                <input type="radio" id="comma-format" name="format" value="comma">
                <label for="comma-format">천단위 구분</label>
            </div>
        </div>
        <select class="season-select" id="season-select">
        </select>
    </div>
</div>

<script src="../static/js/jquery.min.js"></script>
<script src="../static/js/data.js"></script>
<script>
    $(document).ready(function() {
        // 데이터
        const seasonData = globalSeasonData;
        const playerData = Object.fromEntries(
            Object.entries(globalPlayerData).map(([season, rows]) => [
                season,
                rows.map(row =>
                    row.map((v, i) => i === 0 ? v : Number(String(v).replace(/,/g, '')))
                )
            ])
        );

        // 숫자 포맷팅 함수들
        function formatKorean(num) {
            if (!num || num === 0) return '';

            let result = '';
            let remaining = Math.floor(num);

            if (remaining >= 100000000) {
                const eok = Math.floor(remaining / 100000000);
                result += eok + '억';
                remaining = remaining % 100000000;
            }

            if (remaining >= 10000) {
                const man = Math.floor(remaining / 10000);
                result += man + '만';
                remaining = remaining % 10000;
            }

            if (remaining > 0) {
                result += remaining;
            }

            return result;
        }

        function formatComma(num) {
            if (!num || num === 0) return '';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function formatNumber(num) {
            if (!num || num === 0) return '';
            const format = $('input[name="format"]:checked').val();
            return format === 'korean' ? formatKorean(num) : formatComma(num);
        }

        // 티켓당 딜량 계산
        function calculateTicketDamage(damage, count) {
            if (!damage || !count || count === 0) return 0;
            return Math.floor(damage / count);
        }

        // 유틸리티 함수들
        function calculateChange(current, previous) {
            if (!previous || !current || previous === 0) return '';
            const changePercent = ((current - previous) / previous * 100).toFixed(1);
            return changePercent >= 0 ? `+${changePercent}%` : `${changePercent}%`;
        }

        function getChangeClass(changeStr) {
            return changeStr.includes('+') ? 'damage-increase' : 'damage-decrease';
        }

        function getChangeArrow(changeStr) {
            return changeStr.includes('+') ? '↗' : '↘';
        }

        function findPreviousSeasonTicketData(currentSeasonName, playerName, bossIndex) {
            const seasons = seasonData.map(s => s[0]);
            const currentIndex = seasons.indexOf(currentSeasonName);

            for (let i = currentIndex - 1; i >= 0; i--) {
                const seasonName = seasons[i];
                const seasonInfo = seasonData.find(s => s[0] === seasonName);
                const players = playerData[seasonName];

                if (!seasonInfo || !players) continue;

                const activeBosses = seasonInfo[1];
                const bossName = ['드래곤', '대천사', '기계신'][bossIndex];

                if (activeBosses.includes(bossName)) {
                    const player = players.find(p => p[0] === playerName);
                    if (player) {
                        const count = player[bossIndex * 2 + 1];
                        const damage = player[bossIndex * 2 + 2];
                        if (damage > 0 && count > 0) {
                            return calculateTicketDamage(damage, count);
                        }
                    }
                }
            }
            return 0;
        }

        function findPreviousSeasonTotalData(currentSeasonName, playerName, bossIndex) {
            const seasons = seasonData.map(s => s[0]);
            const currentIndex = seasons.indexOf(currentSeasonName);

            for (let i = currentIndex - 1; i >= 0; i--) {
                const seasonName = seasons[i];
                const seasonInfo = seasonData.find(s => s[0] === seasonName);
                const players = playerData[seasonName];

                if (!seasonInfo || !players) continue;

                const activeBosses = seasonInfo[1];
                const bossName = ['드래곤', '대천사', '기계신'][bossIndex];

                if (activeBosses.includes(bossName)) {
                    const player = players.find(p => p[0] === playerName);
                    if (player) {
                        const damage = player[bossIndex * 2 + 2];
                        if (damage > 0) {
                            return damage;
                        }
                    }
                }
            }
            return 0;
        }

        // 컬럼 표시/숨김 업데이트
        function updateColumnVisibility(activeBosses) {
            const bossNames = ['드래곤', '대천사', '기계신'];

            bossNames.forEach((bossName, index) => {
                const isActive = activeBosses.includes(bossName);

                // 컬럼 인덱스 (nth-child는 1부터 시작)
                const bossColIndex = index + 2; // 유저정보(1) 다음부터
                const totalColIndex = index + 6; // 총합(5) 다음부터
                const ticketColIndex = index + 9; // 전시즌대비 3개 다음부터

                if (isActive) {
                    // 보스 딜량 컬럼 표시
                    $(`.data-table th:nth-child(${bossColIndex}), .data-table td:nth-child(${bossColIndex})`).removeClass('hidden-column');
                    // 전시즌 대비 컬럼 표시
                    $(`.data-table th:nth-child(${totalColIndex}), .data-table td:nth-child(${totalColIndex})`).removeClass('hidden-column');
                    // 티켓당 대비 컬럼 표시
                    $(`.data-table th:nth-child(${ticketColIndex}), .data-table td:nth-child(${ticketColIndex})`).removeClass('hidden-column');
                } else {
                    // 보스 딜량 컬럼 숨김
                    $(`.data-table th:nth-child(${bossColIndex}), .data-table td:nth-child(${bossColIndex})`).addClass('hidden-column');
                    // 전시즌 대비 컬럼 숨김
                    $(`.data-table th:nth-child(${totalColIndex}), .data-table td:nth-child(${totalColIndex})`).addClass('hidden-column');
                    // 티켓당 대비 컬럼 숨김
                    $(`.data-table th:nth-child(${ticketColIndex}), .data-table td:nth-child(${ticketColIndex})`).addClass('hidden-column');
                }
            });
        }

        // 시즌 선택 박스 초기화
        function initSeasonSelect() {
            const $select = $('#season-select');
            $select.empty();

            for (let i = seasonData.length - 1; i >= 0; i--) {
                const season = seasonData[i];
                $select.append(`<option value="${season[0]}">≡ ${season[0]}</option>`);
            }
        }

        // 테이블 업데이트
        function updateTable(seasonName) {
            const players = playerData[seasonName];
            const seasonInfo = seasonData.find(s => s[0] === seasonName);
            if (!players || !seasonInfo) return;

            const activeBosses = seasonInfo[1];
            const $tbody = $('#player-tbody');
            $tbody.empty();

            players.forEach(player => {
                const [name, dragonCount, dragonDamage, angelCount, angelDamage, machineCount, machineDamage] = player;

                const totalCount = dragonCount + angelCount + machineCount;
                const totalDamage = dragonDamage + angelDamage + machineDamage;

                const bossData = [
                    { count: dragonCount, damage: dragonDamage, name: '드래곤', index: 0 },
                    { count: angelCount, damage: angelDamage, name: '대천사', index: 1 },
                    { count: machineCount, damage: machineDamage, name: '기계신', index: 2 }
                ];

                // 총 딜량 변화와 티켓당 딜량 변화 계산
                const totalDamageChanges = bossData.map(boss => {
                    if (activeBosses.includes(boss.name) && boss.damage > 0) {
                        const prevTotalDamage = findPreviousSeasonTotalData(seasonName, name, boss.index);
                        return calculateChange(boss.damage, prevTotalDamage);
                    }
                    return '';
                });

                const ticketChanges = bossData.map(boss => {
                    if (activeBosses.includes(boss.name) && boss.damage > 0 && boss.count > 0) {
                        const currentTicketDamage = calculateTicketDamage(boss.damage, boss.count);
                        const prevTicketDamage = findPreviousSeasonTicketData(seasonName, name, boss.index);
                        return calculateChange(currentTicketDamage, prevTicketDamage);
                    }
                    return '';
                });

                const $row = $('<tr>');

                $row.append(`<td class="player-name">${name}</td>`);

                // 각 보스별 딜량 표시 (티켓당 딜량 포함)
                bossData.forEach(boss => {
                    const hasData = boss.count > 0 && boss.damage > 0;

                    if (hasData) {
                        const ticketDamage = calculateTicketDamage(boss.damage, boss.count);
                        $row.append(`
                                <td>
                                    <div class="damage-count">${boss.count}회</div>
                                    <div class="damage-amount">${formatNumber(boss.damage)}</div>
                                    <div class="ticket-damage">(${formatNumber(ticketDamage)})</div>
                                </td>
                            `);
                    } else {
                        $row.append(`
                                <td>
                                    <div class="hidden-content">0회</div>
                                    <div class="hidden-content">0</div>
                                </td>
                            `);
                    }
                });

                $row.append(`
                        <td>
                            <div class="damage-count">${totalCount}회</div>
                            <div class="damage-amount">${formatNumber(totalDamage)}</div>
                        </td>
                    `);

                // 총 딜량 전시즌 대비 추가
                totalDamageChanges.forEach((change, index) => {
                    if (change) {
                        const changeClass = getChangeClass(change);
                        const arrow = getChangeArrow(change);
                        $row.append(`
                                <td>
                                    <span class="damage-change ${changeClass}">
                                        <span class="change-arrow">${arrow}</span>${change}
                                    </span>
                                </td>
                            `);
                    } else {
                        $row.append(`
                                <td>
                                    <span class="hidden-content">0%</span>
                                </td>
                            `);
                    }
                });

                // 티켓당 딜량 전시즌 대비 추가
                ticketChanges.forEach((change, index) => {
                    if (change) {
                        const changeClass = getChangeClass(change);
                        const arrow = getChangeArrow(change);
                        $row.append(`
                                <td>
                                    <span class="damage-change ${changeClass}">
                                        <span class="change-arrow">${arrow}</span>${change}
                                    </span>
                                </td>
                            `);
                    } else {
                        $row.append(`
                                <td>
                                    <span class="hidden-content">0%</span>
                                </td>
                            `);
                    }
                });

                $tbody.append($row);
            });

            // 테이블 데이터 생성 완료 후 컬럼 표시/숨김 적용
            updateColumnVisibility(activeBosses);
        }

        // 이벤트 핸들러
        $('#season-select').on('change', function() {
            updateTable($(this).val());
        });

        $('input[name="format"]').on('change', function() {
            const currentSeason = $('#season-select').val();
            if (currentSeason) {
                updateTable(currentSeason);
            }
        });

        // 초기화
        function init() {
            initSeasonSelect();
            $('#korean-format').prop('checked', true);
            const latestSeason = seasonData[seasonData.length - 1][0];
            $('#season-select').val(latestSeason);
            updateTable(latestSeason);
        }
        init();
    });
</script>
</body>
</html>